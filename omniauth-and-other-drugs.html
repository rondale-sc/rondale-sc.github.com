<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>Omniauth and Other Drugs</title>

  <!-- Twitter Bootstrap -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />

  <!-- My Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css" type="text/css" />

  <link href="/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">

  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

  
    <meta name="description" content="Hello everyone, I'm back.  Here to share a neat piece of code with you.  It isn't very practical but it illustrates how easy it is to use Omniauth" />
  

  
    <meta http-equiv="date" content="Wednesday, 08  2012 00:00:00 GMT" />
  

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25565068-1']);
  _gaq.push(['_setDomainName', 'jonathan-jackson.net']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
  <div class="wrapper">
    <div id="header">
      <h1>run<span class="kern">_</span>with_it <span style="font-size:12px;">Learning, sharing, coding.</span></h1>
      <div class="row">
        <div class="nav-offset site-nav"><a href="/" alt="home">Home</a></div>
        <div class="site-nav"><a href="/about-me.html" alt="about-me">About Me</a></div>
        <div class="site-nav"><a href="/mail.html" alt="contact-me">Email Me</a></div>
      </div>
    </div>
    <div id="header-border"></div>

    <div class="container">
      <div id="content">
       <div id="post">
<h1>Omniauth and Other Drugs</h1>

<p><span style="float:right;"><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span></p>

<p>First of all I&#39;d like to apologize for my extended absence these last few months.  I have been extremely busy revamping three old rails apps, one of which was using rails ~1.2.</p>

<p>Anyways, that&#39;s not what I want to talk about today.  Today is all about Omniauth.  I originally chalked Omniauth up as yet another flavor of the week authentication mechanism.  Boy was I wrong.  Omniauth is an authentication framework that allows you to incorporate standardized &#39;Strategies&#39; quickly in your applications.  It&#39;s a Rack middleware so including it into Rails/Sinatra/whatever is incredibly easy and even fun.  Here I&#39;m going to show you a trick that our team used to create a default provider login in a rails application using Omniauth&#39;s #on<em>failed</em>registration hook.</p>

<p>Surprise Code!</p>

<p><script src='https://gist.github.com/2156513.js?file=gist-1.rb'></script><noscript></p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c">#config/initializers/omniauth.rb</span>
provider :LDAP,
         :host <span class="o">=</span>&gt; <span class="s1">&#39;0.0.0.0&#39;</span>,
         :port <span class="o">=</span>&gt; 389,
         :method <span class="o">=</span>&gt; :plain,
         :base <span class="o">=</span>&gt; <span class="s1">&#39;dc=example,dc=com&#39;</span>,
         :uid <span class="o">=</span>&gt; <span class="s1">&#39;samaccountname&#39;</span>,
         :bind_dn <span class="o">=</span>&gt; <span class="s1">&#39;Authorized User&#39;</span>,
         :password <span class="o">=</span>&gt; <span class="s1">&#39;Password&#39;</span>,
         :name_proc <span class="o">=</span>&gt; Proc.new <span class="o">{</span>|name| name.gsub<span class="o">(</span>/@.*<span class="nv">$/</span>,<span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">}</span>

provider :identity
</code></pre></div>
<p></noscript></p>

<p>Weird combiniation of authorization mechanisms I know, but it will be illustrative. This is what a typical omniauth initializer looks like.  You specify which providers you want to be available and the necessary information required by the strategy.  Most of the strategies available have good documentation, with the possible exception of LDAP ( though it has enough to start ). Once we realized we wanted to have a single custom form (the default forms are kinda bland) that didn&#39;t require the specifying of a provider we started tinkering.</p>

<p><script src='https://gist.github.com/2156513.js?file=gist-2.rb'></script><noscript></p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># First we abstract the parameters of the LDAP</span>
<span class="c"># strategy for use in our callback.</span>

provider :LDAP,
         <span class="nv">ldap_parameters</span> <span class="o">=</span> <span class="o">{</span>  :host <span class="o">=</span>&gt; <span class="s1">&#39;0.0.0.0&#39;</span>,
                              :port <span class="o">=</span>&gt; 389,
                              :method <span class="o">=</span>&gt; :plain,
                              :base <span class="o">=</span>&gt; <span class="s1">&#39;dc=example,dc=com&#39;</span>,
                              :uid <span class="o">=</span>&gt; <span class="s1">&#39;samaccountname&#39;</span>,
                              :bind_dn <span class="o">=</span>&gt; <span class="s1">&#39;Authorized User&#39;</span>,
                              :password <span class="o">=</span>&gt; <span class="s1">&#39;Password&#39;</span>,
                              :name_proc   <span class="o">=</span>&gt; Proc.new <span class="o">{</span>|name| name.gsub<span class="o">(</span>/@.*<span class="nv">$/</span>,<span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">}</span>
                            <span class="o">}</span>
provider :identity

<span class="c">#----- Focus on this code! ------------------------------------</span>

on_failure <span class="k">do</span> |env|
  <span class="c"># Set up variables in case LDAP fails.</span>
  <span class="c"># this is the ugliest part of all of this.</span>
  <span class="c"># especially the strategy gsub (Yuck)</span>
  <span class="nv">message_key</span> <span class="o">=</span> env<span class="o">[</span><span class="s1">&#39;omniauth.error.type&#39;</span><span class="o">]</span>
  <span class="nv">strategy</span>    <span class="o">=</span> env<span class="o">[</span><span class="s1">&#39;omniauth.error.strategy&#39;</span><span class="o">]</span>.class.name.gsub<span class="o">(</span><span class="s1">&#39;OmniAuth::Strategies::&#39;</span>,<span class="s1">&#39;&#39;</span><span class="o">)</span>
  <span class="nv">new_path</span>    <span class="o">=</span> <span class="s2">&quot;#{OmniAuth.config.path_prefix}/failure?provider=#{strategy}&amp;message=#{message_key}&quot;</span>

  <span class="c"># If they failed to authenticate with default strategy. Use LDAP strategy.</span>
  <span class="k">if </span>env<span class="o">[</span><span class="s1">&#39;omniauth.error.strategy&#39;</span><span class="o">]</span>.class <span class="o">==</span> OmniAuth::Strategies::Identity
    <span class="nv">ldap_provider</span> <span class="o">=</span> OmniAuth::Strategies::LDAP.new<span class="o">(</span> @app, ldap_parameters<span class="o">)</span>
    env<span class="o">[</span><span class="s1">&#39;rack.request.form_hash&#39;</span><span class="o">][</span><span class="s1">&#39;username&#39;</span><span class="o">]</span> <span class="o">=</span> env<span class="o">[</span><span class="s1">&#39;rack.request.form_hash&#39;</span><span class="o">][</span><span class="s1">&#39;auth_key&#39;</span><span class="o">]</span>
    ldap_provider.instance_variable_set<span class="o">(</span>:@env, env<span class="o">)</span>
    ldap_provider.callback_call <span class="c"># run LDAP strategy</span>
  <span class="k">else</span>
    <span class="o">[</span>302, <span class="o">{</span><span class="s1">&#39;Location&#39;</span> <span class="o">=</span>&gt; new_path, <span class="s1">&#39;Content-Type&#39;</span><span class="o">=</span>&gt; <span class="s1">&#39;text/html&#39;</span><span class="o">}</span>, <span class="o">[]]</span>
  end
end
</code></pre></div>
<p></noscript></p>

<p>As you can see it&#39;s actually quite trivial to have it call another authentication strategy. You have to set the environment, and in this case the username to be authenticated.  Once that&#39;s done simply call calback_call which performs the steps necessary to run the callback phase of a strategy.</p>

<p>Now that you understand what is going on let me explain our use case.  We have an application that is accessible to clients via the web (for reporting and the like), but is also an important part of our employee&#39;s daily workflow.  We wanted to use this to allow the same form to be used for both people logging in from Identity (clients) and from LDAP (employees).</p>

<p>This accomplished that but felt hackish, so we ended up creating our own oauth strategy/provider.  Still I really like how easy Omniauth made this.  Hope this was interesting.</p>

<h4>References</h4>

<p><span  style="font-size:12px;">1.) <a href="https://github.com/intridea/omniauth">Omniauth</a></span></p>

<h4>Additional References</h4>

<p><span style="font-size:12px;"><a href="http://railscasts.com/episodes/235-omniauth-part-1">Railscasts Omniauth</a></span></p>

<span style="float:right;"><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span>
 <span class="has_js"><g:plusone size="medium"></g:plusone></span>
<!-- Place this render call where appropriate -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'run-with-it';
    var disqus_identifier = '/omniauth-and-other-drugs';
    var disqus_url = 'http://www.jonathan-jackson.net/omniauth-and-other-drugs';
    var disqus_developer = 1;

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
      </div>

      <div id="side-bar">
       <div><a href="http://feeds.feedburner.com/jonathan-jackson/WZqA" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="/images/feeds.png" alt="" style="border:0;width:100px;height:100px;"/></a></div>
<div><img src="/images/gravatar.png" width="167px;" height="167px;"/></div>
<div><a href="https://twitter.com/rondale_sc" class="twitter-follow-button" alt="follow me on twitter" data-width="150px" data-show-count="false">Follow @rondale_sc</a></div>
<div style="margin-top:5px;">
  <h3>Hi, I'm Jon.</h3>
  <p>I love learning new things.  Here is where I'll share what I learn.  Typically code, sometimes my experience, sometimes just a neat trick.</p>
</div>
<a href="/mail.html">
  <img src="http://pairprogramwith.me/badge.png">
</a>
<div>
  <h3>Projects</h3>
  <ul>
    <li><a href="http://rondale-sc.github.com/EspnRb/" alt="espn_rb, a lightweight ruby wrapper around the ESPN api." title="EspnRb">EspnRb</a></li>
    <li><a href="http://jonathan-jackson.net/image_viewer_rails/" alt="ImageViewer image browser w/controls" title="Image Viewer">ImageViewer</a></li>
    <li><a href="https://github.com/rjackson/pivot.js" alt="Pivot.js - reporting lib" title="Pivot.js">Pivot.js</a></li>
    <li><a href="https://github.com/rondale-sc/run_with_it_redux" alt="This blog's Github Repo" title="Run With It Repo">Run With It</a></li>
  </ul>
</div>

      </div>
    </div>
    <div class="push"></div>
  </div>
  <div class="footer">
    <p>Site designed by Jonathan Jackson.  With help from <a href="http://twitter.github.com/bootstrap/" alt="twitter bootstrap">@twbootstrap</a>, <a href="https://github.com/mojombo/jekyll" alt="jekyll">Jekyll</a>, and <a href="https://github.com/" alt="github">github</a></p>
  </div>
</body>
</html>