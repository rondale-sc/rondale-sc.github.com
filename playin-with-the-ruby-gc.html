<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>Playin' with the Ruby GC</title>

  <!-- Twitter Bootstrap -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />

  <!-- My Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css" type="text/css" />

  <link href="/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">

  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

  
    <meta name="description" content="Here I walk you through my attempt at finding the increase (or decrease) in performance from ruby 1.9.2-p290  to 1.9.3-preview1 garbage collection.  I use GC profiler which is a wonderful tool, and some hacks to print a nice little graph.  Check it out." />
  

  
    <meta http-equiv="date" content="Tuesday, 27  2011 00:00:00 GMT" />
  

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25565068-1']);
  _gaq.push(['_setDomainName', 'jonathan-jackson.net']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
  <div class="wrapper">
    <div id="header">
      <h1>run<span class="kern">_</span>with_it <span style="font-size:12px;">Learning, sharing, coding.</span></h1>
      <div class="row">
        <div class="nav-offset site-nav"><a href="/" alt="home">Home</a></div>
        <div class="site-nav"><a href="/about-me.html" alt="about-me">About Me</a></div>
        <div class="site-nav"><a href="/mail.html" alt="contact-me">Email Me</a></div>
      </div>
    </div>
    <div id="header-border"></div>

    <div class="container">
      <div id="content">
       <div id="post">
<h1>Playin&#39; with the Ruby GC</h1>

<p><span><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span></p>

<p>So I, like many of you geeks out there heard about the changes to Ruby in 1.9.3-rc1.  Upon hearing the news, I hurriedly scanned the intra-webz to see if there were any cool features that would affect me or my production apps.  Some of the changes in the release candidate were pleasantly surprising, especially file loading (which saw a notable ~38% speed boost).  When I saw the garbage collector was being changed to something called &quot;Lazy Sweeping&quot; I had to figure out how much this was going to impact performance.  I mean c&#39;mon &quot;lazy sweeping&quot;, sounds so interesting right?  So I started writing a script to tell me just that.</p>

<p>Let&#39;s start this in reverse order.</p>

<h2>The results</h2>

<p>I found that the the new &quot;lazy sweeping&quot; (still super cool name) was about <em>8%</em> faster on average.  Here&#39;s the pretty graph I created from Excel.</p>

<p><img src="http://www.jonathan-jackson.net/images/gc_graph.png" alt="gc graph" style="width:600px"/></p>

<p>The vertical axis is the time in milliseconds, and the horizontal axis represents the GC cycle during the creation of ~10,000 objects.  Alright alright alright.  I&#39;ll explain the methodology so you can actually understand the graph.</p>

<h2>The Methodology</h2>

<p>While doing the research I came across a nifty little script by the Narihiro Nakamura <a href="http://redmine.ruby-lang.org/attachments/959/bm_gc_fragmentation.rb">here</a>.  I modified it slightly, but kept the same idea of creating a number of objects to fill up the heap.</p>

<p><script src='https://gist.github.com/2156260.js?file=gist-1.rb'></script><noscript></p>
<div class="highlight"><pre><code class="sh"><span class="c"># &#39;./gc_test.rb&#39;</span>

@m <span class="o">=</span> 1000000
@b <span class="o">=</span> 2 * 5 * <span class="o">(</span>4**3<span class="o">)</span> + 1
@a <span class="o">=</span> 100001

def make_fragmentation<span class="o">(</span>h, seed<span class="o">)</span>
  <span class="nv">i</span> <span class="o">=</span> seed
  10000.times <span class="o">{</span>|m| h &lt;&lt; Object.new<span class="o">}</span>
  10000.times <span class="k">do</span> |m|
    <span class="nv">i</span> <span class="o">=</span> <span class="o">((</span>@a * i<span class="o">)</span> + @b<span class="o">)</span> % @m
    h<span class="o">[</span>i % h.length<span class="o">]</span> <span class="o">=</span> nil
 end
end

def run_test
  GC::Profiler.enable
  <span class="nv">heaps</span> <span class="o">=</span> <span class="o">[]</span>
  100.times<span class="o">{</span>|i| make_fragmentation<span class="o">(</span>heaps, i<span class="o">)</span> <span class="o">}</span>
  GC::Profiler.result
end

puts run_test
</code></pre></div>
<p></noscript></p>

<p>This returns a result set from the GC profiler.  Which I call about a hundred times like so:</p>

<p><script src='https://gist.github.com/2156260.js?file=gist-2.rb'></script><noscript></p>
<div class="highlight"><pre><code class="sh">require <span class="s1">&#39;bigdecimal&#39;</span>
require <span class="s1">&#39;pp&#39;</span>

<span class="nv">output</span> <span class="o">=</span> Hash.new<span class="o">([])</span>
@totals <span class="o">=</span> <span class="o">{}</span>

<span class="nv">path</span> <span class="o">=</span> <span class="s1">&#39;./gc_test.rb&#39;</span>

100.times <span class="k">do</span> |test_run|
 <span class="nv">result_set</span> <span class="o">=</span> <span class="sb">`</span>ruby <span class="c">#{path}` # this is where we get the result from the previous script</span>
 result_set.split<span class="o">(</span><span class="s2">&quot;\n&quot;</span><span class="o">)</span>.each_with_index <span class="k">do</span> |result, index|
   next <span class="k">if</span> <span class="o">[</span>0,1<span class="o">]</span>.include?<span class="o">(</span>index<span class="o">)</span>
   <span class="nv">result</span> <span class="o">=</span> result.split<span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">)</span>
   output<span class="o">[</span>result<span class="o">[</span>0<span class="o">]]</span> +<span class="o">=</span> <span class="o">[</span>result<span class="o">[</span>5<span class="o">]]</span>
 end
end

<span class="c"># This is where we take the cumulative values of the previous 100 results sets by GC cycle</span>
<span class="c"># and grab the average.  Big decimal because we want to be precise and the numbers are already</span>
<span class="c"># strings.</span>

output.each <span class="k">do</span> |k,v|
  <span class="nv">length</span> <span class="o">=</span> BigDecimal.new<span class="o">(</span>v.length.to_s<span class="o">)</span>
  <span class="nv">nv</span> <span class="o">=</span> v.map! <span class="o">{</span>|i| BigDecimal.new<span class="o">(</span>i<span class="o">)}</span>
  @totals<span class="o">[</span>k<span class="o">]</span> <span class="o">=</span> <span class="o">(</span>nv.inject<span class="o">(</span>:+<span class="o">)</span> / length<span class="o">)</span>.to_s<span class="o">(</span><span class="s2">&quot;F&quot;</span><span class="o">)</span>
end
puts @totals.map<span class="o">{</span>|k,v| v + <span class="s2">&quot;\n&quot;</span><span class="o">}</span>
</code></pre></div>
<p></noscript></p>

<p>I attempted to run this ten thousand times but it just took too long.  I wanted to get a large sample because the GC can run at off times and isn&#39;t at all guaranteed to be consistent. I ended up just going with a 100 run set for sake of speed.  Once I had the script all set I just used RVM to set my ruby and ran it.  As of writing this article RVM didn&#39;t offer 1.9.3-rc1 so I used 1.9.3-preview1 instead.</p>

<h2>The interpretation</h2>

<p>Well as I said before &quot;lazy sweeping&quot; is about 8% faster on average.  The largest increases in speed was when there were a small/medium number of objects in memory, the larger the number of objects the more 1.9.2 won out over 1.9.3. <a href="http://www.infoq.com/">InfoQ</a> talked to Narihiro Nakamura <a href="#footnote_2">[2]</a> where he explains why these results are likely accurate.</p>

<blockquote>
<p>If the program creates many long-lived objects, lazy sweep may not be able to find a free object. In that case, lazy sweep spends a long time on a single object allocation. I think that in most cases, the performance of this should still be better than M&amp;S GC.</p>
</blockquote>

<p>This InfoQ article was especially enlightening so I recommend giving it a glance through (it&#39;s in the footnote).</p>

<h2>Try it yourself</h2>

<p>The GC module offers many ways to examine the garbage collector. If you want something more, then you should look into ruby-prof which has options that show you GC<em>TIME, GC</em>RUNS and a whole host of other useful profiling tools.  @wycats recently pushed a branch to ruby-prof that enables those GC operations, you can find it <a href="https://github.com/wycats/ruby-prof">here</a>.  You&#39;ll note that it requires ruby to be patched.  So try ruby-prof out!</p>

<p>Anyways, I know this wasn&#39;t exactly scientific but it was certainly fun and helped me understand some things about ruby a little better. Hope it helps you too.</p>

<p>Have an improvement to the scripts above?  Think I&#39;m doing something completely wrong? Maybe you have an entirely different approach.  Let me know in the comments below, and don&#39;t forget to subscribe to &#39;Run With It&#39;.</p>

<h4>References</h4>

<ul>
<li><span  style="font-size:12px;">1.) <a id="footnote_1" href="http://www.redmine.org/">RedMine Script</a></span></li>
<li><span  style="font-size:12px;">2.) <a id="footnote_2" href="http://www.infoq.com/news/2011/08/ruby193-gc;jsessionid=AD723DB6898A9A0A368C5A1D9A5D2DAA">InfoQ Interview with Narihiro Nakamura, 2011</a></span></li>
</ul>

<h4>Additional References (Reading)</h4>

<p><a href=""></a>
<ul>
  <li><span style="font-size:12px;"><a href="http://blog.envylabs.com/2010/07/garbage-collection-the-ruby-heap/">Joe Damato, 2010</a></span></li>
  <li><span style="font-size:12px;"><a href="http://ruby-prof.rubyforge.org/">Ruby Prof</a></span></li>
</ul></p>

<span><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span> <span class="has_js"><g:plusone size="medium"></g:plusone></span>
<!-- Place this render call where appropriate -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'run-with-it';
    var disqus_identifier = '/playin-with-the-ruby-gc';
    var disqus_url = 'http://www.jonathan-jackson.net/playin-with-the-ruby-gc';
    var disqus_developer = 1;

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
      </div>

      <div id="side-bar">
       <div><a href="http://feeds.feedburner.com/jonathan-jackson/WZqA" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="/images/feeds.png" alt="" style="border:0;width:100px;height:100px;"/></a></div>
<div><img src="/images/gravatar.png" width="167px;" height="167px;"/></div>
<div><a href="https://twitter.com/rondale_sc" class="twitter-follow-button" alt="follow me on twitter" data-width="150px" data-show-count="false">Follow @rondale_sc</a></div>
<div style="margin-top:5px;">
  <h3>Hi, I'm Jon.</h3>
  <p>I love learning new things.  Here is where I'll share what I learn.  Typically code, sometimes my experience, sometimes just a neat trick.</p>
</div>
<div>
  <h3>Subscribe via Email</h3>
  <!-- Begin MailChimp Signup Form -->
  <link href="http://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
  <div id="mc_embed_signup">
  <form action="http://jonathan-jackson.us5.list-manage.com/subscribe/post?u=266baf97eddd87cfd15f1d015&amp;id=1ffe6549dc" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank">
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn"></div>
  </form>
  </div>
  <!--End mc_embed_signup-->
</div>
<div>
  <h3>Projects</h3>
  <ul>
    <li><a href="http://rondale-sc.github.com/EspnRb/" alt="espn_rb, a lightweight ruby wrapper around the ESPN api." title="EspnRb">EspnRb</a></li>
    <li><a href="https://github.com/rondale-sc/image_viewer" alt="ImageViewer image browser w/controls" title="Image Viewer">ImageViewer</a></li>
    <li><a href="https://github.com/rjackson/pivot.js" alt="Pivot.js - reporting lib" title="Pivot.js">Pivot.js</a></li>
    <li><a href="https://github.com/rondale-sc/run_with_it_redux" alt="This blog's Github Repo" title="Run With It Repo">Run With It</a></li>
  </ul>
</div>
      </div>
    </div>
    <div class="push"></div>
  </div>
  <div class="footer">
    <p>Site designed by Jonathan Jackson.  With help from <a href="http://twitter.github.com/bootstrap/" alt="twitter bootstrap">@twbootstrap</a>, <a href="https://github.com/mojombo/jekyll" alt="jekyll">Jekyll</a>, and <a href="https://github.com/" alt="github">github</a></p>
  </div>
</body>
</html>