<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>Ruby Hough Hack</title>

  <!-- Twitter Bootstrap -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />

  <!-- My Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css" type="text/css" />

  <link href="/images/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">

  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

  
    <meta name="description" content="The hough transform is an algorithm used to detect edges/objects in an image.  I recently needed to use it to straighten an image so that I could process it.  Here is the (imperfect) solution me and my brother hacked out today." />
  

  
    <meta http-equiv="date" content="Wednesday, 21  2011 00:00:00 GMT" />
  

  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25565068-1']);
  _gaq.push(['_setDomainName', 'jonathan-jackson.net']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
  <div class="wrapper">
    <div id="header">
      <h1>run<span class="kern">_</span>with_it <span style="font-size:12px;">Learning, sharing, coding.</span></h1>
      <div class="row">
        <div class="nav-offset site-nav"><a href="/" alt="home">Home</a></div>
        <div class="site-nav"><a href="/about-me.html" alt="about-me">About Me</a></div>
        <div class="site-nav"><a href="/mail.html" alt="contact-me">Email Me</a></div>
      </div>
    </div>
    <div id="header-border"></div>

    <div class="container">
      <div id="content">
       <div id="post">
<h1>Ruby Hough Hack</h1>

<p><span style="float:right;"><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span></p>

<p>The hough transform<a href="#footnote_1">[1]</a> is an algorithm used to detect lines <s>detect edges/objects</s> in an image. I recently needed to use it to straighten an image so that I could process it. Here is the solution me and my brother hacked out today using Chunky PNG</p>

<p><script src='https://gist.github.com/2156226.js?file=gist-1.rb'></script><noscript></p>
<div class="highlight"><pre><code class="sh language-sh" data-lang="sh"><span class="c"># Authors: Robert Jackson, Jonathan Jackson</span>
<span class="c"># the formatting of this file has been altered in</span>
<span class="c"># order to fit on this website. Check out</span>
<span class="c"># https://gist.github.com/1233581 if you care</span>

require <span class="s1">&#39;chunky_png&#39;</span> <span class="c">#or &#39;oily_png&#39;</span>
class Hough
  def initialize<span class="o">(</span>image_path, <span class="nv">options</span><span class="o">={})</span>
    @image <span class="o">=</span> ChunkyPNG::Image.from_file<span class="o">(</span>image_path<span class="o">)</span>
    @image_path <span class="o">=</span> image_path
    @angles <span class="o">||=</span> <span class="o">{}</span>
  end
  def is_dark?<span class="o">(</span>color<span class="o">)</span>
    ChunkyPNG::Color.r<span class="o">(</span>color<span class="o">)</span> +
    ChunkyPNG::Color.g<span class="o">(</span>color<span class="o">)</span> +
    ChunkyPNG::Color.b<span class="o">(</span>color<span class="o">)</span> &lt; 40
  end
  def is_light?<span class="o">(</span>color<span class="o">)</span>
    ChunkyPNG::Color.r<span class="o">(</span>color<span class="o">)</span> +
    ChunkyPNG::Color.g<span class="o">(</span>color<span class="o">)</span> +
    ChunkyPNG::Color.b<span class="o">(</span>color<span class="o">)</span> &gt; 600
  end
  def angles<span class="o">(</span>theta<span class="o">)</span>
    @angles<span class="o">[</span>theta<span class="o">]</span> <span class="o">||=</span> <span class="o">{</span>
      :cos <span class="o">=</span>&gt; Math.cos<span class="o">(</span>theta<span class="o">)</span>,
      :sin <span class="o">=</span>&gt; Math.sin<span class="o">(</span>theta<span class="o">)</span>
    <span class="o">}</span>
  end
  def get_hough_matrix
    <span class="nv">hough</span> <span class="o">=</span> Hash.new<span class="o">(</span>0<span class="o">)</span>

    <span class="c"># iterate over every point of the image &#39;Hooray Chunky Png&#39;</span>
    @image.height.times <span class="k">do</span> |y|
      @image.width.times <span class="k">do</span> |x|

        <span class="c"># run the point through hough transform only if the</span>
        <span class="c"># sum of the points&#39; rgb values are less than 40 (are black)</span>
        <span class="c"># and the point directly below&#39;s( y+1 ) rgb values</span>
        <span class="c"># are greater than 600 (are white)</span>
        <span class="k">if </span>is_dark?<span class="o">(</span>@image<span class="o">[</span>x,y<span class="o">])</span> <span class="o">&amp;&amp;</span> is_light?<span class="o">(</span>@image<span class="o">[</span>x,y + 1<span class="o">])</span>

          <span class="c"># run r = xcos(theta) + ysin(theta) from 0 to 20</span>
          <span class="c"># stepping 0.2 at a time</span>
          <span class="o">(</span>0..20<span class="o">)</span>.step<span class="o">(</span>0.2<span class="o">)</span>.each <span class="k">do</span> |theta|

            <span class="c"># http://en.wikipedia.org/wiki/Hough_transform&quot;</span>
            <span class="nv">distance</span> <span class="o">=</span> <span class="o">(</span>
                        x * angles<span class="o">(</span>theta<span class="o">)[</span>:cos<span class="o">]</span> +
                        y * angles<span class="o">(</span>theta<span class="o">)[</span>:sin<span class="o">]</span>
                      <span class="o">)</span>.to_i

            <span class="c"># populate [theta, distance] as key to hough and increment</span>
            <span class="c"># the point&#39;s score</span>
            hough<span class="o">[[</span>theta, distance<span class="o">]]</span> +<span class="o">=</span> 1 <span class="k">if </span>distance &gt;<span class="o">=</span> 0
          end
        end
      end
    end
    <span class="k">return </span>hough
  end

  def average_theta
    <span class="c"># sort by score, grab top twenty, sum (inject) and divide by length to</span>
    <span class="c"># get the average. (after #sort_by hough looks like</span>
    <span class="c"># [[theta, distance] score]) so v[0][0] is just score</span>
    get_hough_matrix.sort_by <span class="o">{</span>|k,v| v <span class="o">}</span>.take<span class="o">(</span>20<span class="o">)</span>.inject<span class="o">(</span>0.0<span class="o">)</span> <span class="o">{</span> |sum,v|
      sum + v<span class="o">[</span>0<span class="o">][</span>0<span class="o">]</span>
     <span class="o">}</span> / 20
  end
end
</code></pre></div>
<p></noscript></p>

<p>Was fun to work on.  Hope someone finds a use for it.  Just remember that the important part here is how you define your restriction.  In my case I was looking for a straight black line.</p>

<p>The gist is <a href="https://gist.github.com/1233581">here</a>.</p>

<p>***edit zzgwon pointed out that the hough algorithm is used for line detection not object detection.</p>

<p>*** edit RIP_Kashin pointed out a few errors in the initialize function, namely a stray &#39;a&#39;.  Unfortunately I can&#39;t render strike through so you&#39;ll have to trust me.</p>

<h4>References</h4>

<ul>
  <li><span  style="font-size:12px;">1.) <a id="footnote_1" href="http://en.wikipedia.org/wiki/Hough_transform">Wikipedia</a></span></li>
</ul>

<h4>Additional References</h4>

<ul>
  <li><span  style="font-size:12px;"><a id="footnote_1" href="http://www.codeproject.com/KB/graphics/Deskew_an_Image.aspx">Code Project; How to Deskew an image</a></span></li>
  <li><span  style="font-size:12px;"><a id="footnote_1" href="http://www.seas.upenn.edu/~bensapp/opencvdocs/ref/opencvref_cv.htm">Open CV</a></span></li>
</ul>

<span style="float:right;"><a href="http://twitter.com/share" class="twitter-share-button"
                                         data-count="horizontal"
                                         data-via="rondale_sc">Tweet</a>
</span>
 <span class="has_js"><g:plusone size="medium"></g:plusone></span>
<!-- Place this render call where appropriate -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'run-with-it';
    var disqus_identifier = '/ruby-hough-hack';
    var disqus_url = 'http://www.jonathan-jackson.net/ruby-hough-hack';
    var disqus_developer = 1;

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
      </div>

      <div id="side-bar">
       <div><a href="http://feeds.feedburner.com/jonathan-jackson/WZqA" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="/images/feeds.png" alt="" style="border:0;width:100px;height:100px;"/></a></div>
<div><img src="/images/gravatar.png" width="167px;" height="167px;"/></div>
<div><a href="https://twitter.com/rondale_sc" class="twitter-follow-button" alt="follow me on twitter" data-width="150px" data-show-count="false">Follow @rondale_sc</a></div>
<div style="margin-top:5px;">
  <h3>Hi, I'm Jon.</h3>
  <p>I love learning new things.  Here is where I'll share what I learn.  Typically code, sometimes my experience, sometimes just a neat trick.</p>
</div>
<a href="/mail.html">
  <img src="http://pairprogramwith.me/badge.png">
</a>
<div>
  <h3>Projects</h3>
  <ul>
    <li><a href="http://rondale-sc.github.com/EspnRb/" alt="espn_rb, a lightweight ruby wrapper around the ESPN api." title="EspnRb">EspnRb</a></li>
    <li><a href="http://jonathan-jackson.net/image_viewer_rails/" alt="ImageViewer image browser w/controls" title="Image Viewer">ImageViewer</a></li>
    <li><a href="https://github.com/rjackson/pivot.js" alt="Pivot.js - reporting lib" title="Pivot.js">Pivot.js</a></li>
    <li><a href="https://github.com/rondale-sc/run_with_it_redux" alt="This blog's Github Repo" title="Run With It Repo">Run With It</a></li>
  </ul>
</div>

      </div>
    </div>
    <div class="push"></div>
  </div>
  <div class="footer">
    <p>Site designed by Jonathan Jackson.  With help from <a href="http://twitter.github.com/bootstrap/" alt="twitter bootstrap">@twbootstrap</a>, <a href="https://github.com/mojombo/jekyll" alt="jekyll">Jekyll</a>, and <a href="https://github.com/" alt="github">github</a></p>
  </div>
</body>
</html>